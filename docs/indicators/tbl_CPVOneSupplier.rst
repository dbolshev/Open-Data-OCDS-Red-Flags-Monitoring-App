.. _tbl_CPVOneSupplier:

tbl_CPVOneSupplier
==================

Данная аналитическая таблица хранит все коды предметов закупок для каждой закупающей организации и поставщика, которые поставщик поставлял закупающей организации в календарном году по прямому договору по причине "приобретения товаров, работ и услуг по каждой статье расходов один раз в год до минимальной пороговой суммы". 

Данная аналитическая таблица содержит следующую информацию:
 - Идентификатор закупающей организации;
 - Идентификатор поставщика;
 - Первые 6 цифр кода предмета закупки (ОКГЗ 6);
 - Сумма предмета закупки;
 - Дата завершения процедуры;
 - Дата объявления процедуры закупки.

Пример того, как может выглядеть таблица:

======================== =========== ======== ======= ====== =====
Закупающая организация   Поставщик   ОКГЗ 6   Сумма   Дата   Год
------------------------ ----------- -------- ------- ------ -----
Закупающая организация 1 Поставщик 1 ОКГЗ 6 1 Сумма 1 Дата 1 Год 1    
Закупающая организация 1 Поставщик 2 ОКГЗ 6 2 Сумма 2 Дата 2 Год 2
Закупающая организация 1 Поставщик 2 ОКГЗ 6 3 Сумма 3 Дата 3 Год 1
Закупающая организация 2 Поставщик 1 ОКГЗ 6 4 Сумма 4 Дата 1 Год 1
Закупающая организация 2 Поставщик 4 ОКГЗ 6 5 Сумма 5 Дата 2 Год 1
....                     ....        ...      ...     ...    ...
======================== =========== ======== ======= ====== =====

****************************
Расчет аналитической таблицы
****************************

****************************
Источники данных для расчета
****************************

Для расчета аналитической таблицы используются следующие источники данных:

- API системы государственных закупок в OCDS формате.

*************************************
Частота расчета аналитической таблицы
*************************************

Аналитическая таблица рассчитывается 1 раз в сутки.

****************
Поля для расчета
****************

- ``data.tender.datePublished``
- ``data.tender.procurementMethodRationale``
- ``data.parties.roles``
- ``data.parties.identifier.scheme``
- ``data.parties.identifier.id``
- ``data.awards.status``
- ``data.awards.relatedBid``
- ``data.bids.details.priceProposal.relatedItem``
- ``data.bids.details.priceProposal.unit.value.amount``
- ``data.bids.tenderers.id``
- ``data.tender.bids.id``
- ``data.tender.items.id``
- ``data.tender.items.quantity``
- ``data.tender.items.classification.id``
- ``data.tender.items.classification.scheme``

***********************
Формула расчета таблицы
***********************
1. Перед расчетом таблица для текущего календарного года очищается. Таблицы, расчитанные для более ранних годов остаются без пересчета.
2. Выбираем только те процедуры, у которых ``data.tender.procurementMethodRationale = 'annualProcurement'``. И только процедуры на поставку товаров. Из них выбираем только те процедуры, у которых ``data.tender.datePublished`` находится в текущем году и которые имеют ``data.tender.status = 'complete'``.
3. Находим идентификатор закупающей организации (конкатенация ``data.parties.identifier.scheme`` и ``data.parties.identifier.id``), такой, что ``data.parties.roles = 'buyer, procuringEntity'``.
4. Определяем дату завершения процедуры ``data.tender.date``.
5. Выбираем все объекты определения победителя, которые имеют ``data.awards.status = 'active'``.
6. Выбираем ценовое предложение, которое победило в определении победителя ``data.bids.id = data.awards.relatedBid``.
7. В ценовом предложении находим идентификатор предметов закупки ``data.bids.details.priceProposal.relatedItem`` и стоимости единиц предметов закупки ``data.bids.details.priceProposal.unit.value.amount``` и идентификатор поставщика ``data.bids.tenderers.id``.
8. По идентификатору предмета закупки находим позицию в тендерном объявлении ``data.bids.details.priceProposal.relatedItem = data.tender.items.id``.
9. Из позиции в тендерном предложении находим код предмета закупки (``data.tender.items.classification.id``) а также количество закупаемых единиц ``data.tender.items.quantity``.
10. Находим категорию для предмета закупки - первые 6 знаков в коде.
11. Находим сумму по предмету закупки: количество ``data.tender.items.quantity`` умножаем на стоимость ``data.bids.details.priceProposal.unit.value.amount``.
12. Идентификатор закупающей организации, идентификатор поставщика, категорию предмета закупки, сумму закупки, дату завершения процедуры и год, для которого считалась таблица, заносим в таблицу.
